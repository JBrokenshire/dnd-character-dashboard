<script setup lang="ts">
import { onMounted, ref } from 'vue'
import { modifierFromLevel } from '@/utils/utils'
import { type Skill, skills } from '@/models/Skill'
import { type Character, characterProficiencyBonus } from '@/models/Character'
import {
  getCharacterProficientSkills,
  getCharacterSkillsAdvantages
} from '@/services/CharacterSkillService'
import type { CharacterSkillAdvantage } from '@/models/CharacterSkillsAdvantage'
import SkillListItem from '@/components/character/sheet/subsections/skills/SkillListItem.vue'

const props = defineProps<{
  className: string
  character: Character
}>()

onMounted(async () => {
  const proficientSkillsRes = await getCharacterProficientSkills(props.character.id)
  proficientSkillsRes.map((skill) =>
    proficientSkills.value.set(skill.skill_name, skill.proficiency_type)
  )
  const skillsAdvantagesRes = await getCharacterSkillsAdvantages(props.character.id)
  skillsAdvantagesRes.map((skillAdvantage) =>
    skillsAdvantages.value.set(skillAdvantage.skill_name, skillAdvantage)
  )

  console.log(skillsAdvantages.value)

  loading.value = false
})

const proficientSkills = ref<Map<string, string>>(new Map<string, string>())
const skillsAdvantages = ref<Map<string, CharacterSkillAdvantage>>(
  new Map<string, CharacterSkillAdvantage>()
)
const loading = ref(true)

const getSkillModifier = (skill: Skill): number => {
  let modifier = 0

  switch (skill.ability) {
    case 'Strength':
      modifier = modifierFromLevel(props.character.strength)
      break
    case 'Dexterity':
      modifier = modifierFromLevel(props.character.dexterity)
      break
    case 'Intelligence':
      modifier = modifierFromLevel(props.character.intelligence)
      break
    case 'Wisdom':
      modifier = modifierFromLevel(props.character.wisdom)
      break
    case 'Charisma':
      modifier = modifierFromLevel(props.character.charisma)
      break
  }

  if (proficientSkills.value.has(skill.name)) {
    let profBonus = characterProficiencyBonus(props.character.level)
    switch (proficientSkills.value.get(skill.name)) {
      case 'Proficiency':
        modifier += profBonus
        break
      case 'Half-Proficiency':
        modifier += Math.floor(profBonus / 2)
        break
      case 'Expertise':
        modifier += profBonus * 2
        break
    }
  }

  return modifier
}
</script>

<template>
  <div v-if="!loading" class="absolute top-0 left-[236px] xl:left-[286px]">
    <div class="relative h-[765px] w-[230px] xl:w-[281px] py-[13px] px-[20px]">
      <div class="svg-background">
        <!-- Large Screen SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 281 765" class="hidden xl:block">
          <path
            fill="#10161ADB"
            d="M275.08,719a32.47,32.47,0,0,0-1.23-4.29c-1.71-4.36-1.13-582.66-1.13-582.66s0-30.43-.58-49c-.36-11.85,1.72-26.54,3.28-35.6a4,4,0,0,1-1.49-1.64c-1.7-3.61-2.41-7.49-1-11.35a6.27,6.27,0,0,1,.93-1.69c-.7-3.15-.33-6.48-1.3-9.54a42.76,42.76,0,0,0-3.54-7,18.66,18.66,0,0,0-5-6.37c-2-1.48-4.08-2.5-5.8-4.27-1.74-.72-3.49-1.42-5.2-2.21l-.4-.21H29.41a5.1,5.1,0,0,1-3.58,1.27,5.83,5.83,0,0,1-2.25,1.44L23.19,6,23,6.05c-.42.25-.87.47-1.29.74a7.34,7.34,0,0,0-1.22.84c1-.91-.26.24-.45.41a5.85,5.85,0,0,1-2.83,1.33,52.05,52.05,0,0,0-3.9,4c-4.59,5.47-4.83,13.51-6.24,20.2,0,.14-.08.27-.11.4a11.08,11.08,0,0,1,.29,1.52c-.16-1.2.09.35.14.59q.14.63.3,1.26a21,21,0,0,0,.88,2.57c1.07,2.59-1.17,5.4-3.49,6.15a3.22,3.22,0,0,1-.7.14C5.94,55.14,8.24,70.62,7.86,83c-.58,18.57-.58,49-.58,49s.64,576.13-1,587.33a5.14,5.14,0,0,1,3.07,6,29.15,29.15,0,0,1-2.67,7,4.68,4.68,0,0,1,.85,2.91c-.27,14.38,12.13,22.59,23.77,28.18a5.7,5.7,0,0,1,.88.53h216.9a5.09,5.09,0,0,1,2.84-1.08,4.1,4.1,0,0,1,1.59-1.45c1-.5,2.07-.93,3.12-1.37l.64-.27-.55.24a6.87,6.87,0,0,0,1.29-.6c.22-.11.45-.18.68-.27,1-1,1.86-1.92,2.41-2.37,2.91-2.43,6.23-4.26,7.86-7.81a4.38,4.38,0,0,1,1.74-2c.81-4.9,2.13-9.72,2.58-14.7a5.32,5.32,0,0,1,.57-2c0-.19-.07-.36-.11-.51-.38-1.74-.87-3.44-1.28-5.17A4.8,4.8,0,0,1,275.08,719Z"
          />
          <path
            :class="className"
            d="M275.28,654.52v-554c.77-12.76,2.64-38.62,5.52-48.14l.21-.69-.6-.38a21.36,21.36,0,0,1-3.68-3.14,62.8,62.8,0,0,1,2.34-9.56l.12-.34L276.7,10.17l-1.08-.34c-2.52-.8-9.71-4-9.71-8.12V0H15.09V1.71c0,4.13-7,7.26-9.71,8.12l-1.08.34L1.82,38.28l.12.34a64,64,0,0,1,2.34,9.54A21,21,0,0,1,.6,51.32L0,51.7l.21.69C3.09,61.89,5,87.7,5.72,100.48v554C5,667.23,3.09,703.1.21,712.61L0,713.3l.6.38a20.83,20.83,0,0,1,3.68,3.14,61.64,61.64,0,0,1-2.34,9.56l-.12.35,2.48,28.1,1.08.34c2.7.86,9.71,4,9.71,8.12V765H265.91v-1.71c0-4.13,7-7.26,9.71-8.12l1.08-.34,2.48-28.1-.12-.35a64,64,0,0,1-2.34-9.54,21,21,0,0,1,3.68-3.16l.6-.38-.21-.69c-2.88-9.5-4.74-45.31-5.51-58.09m-3.84,73.29s.45,1.07,1,2.61a29.79,29.79,0,0,1-1.33,12.42C268.18,751.6,261,758,250.25,761.58H30.68c-23-7.63-22.8-25.7-22.16-31.09.59-1.63,1.06-2.75,1.09-2.83a12.21,12.21,0,0,0-2.1-9.76c3.38-18.83,1.66-42.81,1.58-43.89V91.12c.09-1.19,1.81-25.21-1.57-44.05a12.41,12.41,0,0,0,2.05-9.88s-.45-1.07-1-2.61A29.8,29.8,0,0,1,9.87,22.16C12.82,13.4,20,7,30.76,3.42H250.32c23.05,7.63,22.8,25.7,22.16,31.09-.59,1.63-1.06,2.75-1.09,2.84a12.19,12.19,0,0,0,2.1,9.75c-3.38,18.83-1.66,42.81-1.58,43.89V673.88c-.09,1.19-1.81,25.21,1.57,44a12.41,12.41,0,0,0-2.05,9.88m7.41-675.3c-1.71,6.15-3,17.57-4,28.45a191.48,191.48,0,0,1,1.5-30.51,23.59,23.59,0,0,0,2.5,2.06m-5.72-14.58c.09-.21,1.13-2.72,2.12-5.82l.51,5.74A61.16,61.16,0,0,0,274,44.4a9.5,9.5,0,0,1-.89-6.47m.42-25.21,1.24,14.07c-.25,1.21-.59,2.48-1,3.69a30.1,30.1,0,0,0-1.55-8.72c-2-6-6.88-13.57-18.42-18.34h8.89c1.25,5.24,8,8.26,10.8,9.3M18.25,3.42h8.88C10.49,10.29,7.46,23.17,7.21,30.61c-.38-1.25-.74-2.56-1-3.82L7.45,12.72c2.79-1,9.55-4.06,10.8-9.3m-13,34.43.51-5.74c1,3.07,2,5.53,2.07,5.66A9.73,9.73,0,0,1,7,44.33a62.24,62.24,0,0,0-1.73-6.48m-.6,12.59A191.42,191.42,0,0,1,6.15,81c-1-10.87-2.29-22.29-4-28.44a21.9,21.9,0,0,0,2.49-2.07M2.15,712.49c1.71-6.15,3-17.57,4-28.44a191.41,191.41,0,0,1-1.5,30.5,23.59,23.59,0,0,0-2.5-2.06m5.72,14.58c-.09.21-1.13,2.72-2.12,5.82l-.51-5.74A60.54,60.54,0,0,0,7,720.6a9.5,9.5,0,0,1,.89,6.47m-.42,25.21L6.21,738.21c.25-1.21.59-2.47,1-3.69a30,30,0,0,0,1.55,8.72c2,6,6.88,13.57,18.42,18.34H18.25c-1.25-5.24-8-8.26-10.8-9.3m255.3,9.3h-8.88c16.64-6.86,19.67-19.75,19.92-27.19.38,1.26.74,2.56,1,3.82l-1.24,14.07c-2.79,1-9.55,4.06-10.8,9.3m13-34.43-.51,5.74c-1-3.08-2-5.53-2.07-5.66a9.73,9.73,0,0,1,.85-6.56,62.24,62.24,0,0,0,1.73,6.48m.6-12.59a191.37,191.37,0,0,1-1.51-30.51c1,10.88,2.29,22.29,4,28.44a21.9,21.9,0,0,0-2.49,2.07"
          />
        </svg>

        <!-- Small Screen SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 230 765" class="block xl:hidden">
          <path
            fill="#10161ADB"
            d="M224.09593,719a32.58075,32.58075,0,0,0-1.22463-4.29c-1.70252-4.36-1.12506-582.66-1.12506-582.66s0-30.43-.57746-49c-.35841-11.85,1.71249-26.54,3.26566-35.6a3.99385,3.99385,0,0,1-1.48347-1.64c-1.69258-3.61-2.39947-7.49-.99563-11.35a6.27817,6.27817,0,0,1,.92593-1.69c-.697-3.15-.32855-6.48-1.29431-9.54a42.83292,42.83292,0,0,0-3.52453-7,18.648,18.648,0,0,0-4.97814-6.37c-1.99126-1.48-4.06215-2.5-5.77463-4.27-1.73238-.72-3.47475-1.42-5.17726-2.21l-.39825-.21H29.28142a5.06422,5.06422,0,0,1-3.56435,1.27,5.80144,5.80144,0,0,1-2.24016,1.44l-.3883.12-.18917.05c-.41816.25-.86619.47-1.28436.74a7.30725,7.30725,0,0,0-1.21466.84c.99563-.91-.25887.24-.448.41a5.81329,5.81329,0,0,1-2.81762,1.33,51.94484,51.94484,0,0,0-3.88295,4c-4.56993,5.47-4.80889,13.51-6.21272,20.2a1.8288,1.8288,0,0,1-.10952.4,11.12318,11.12318,0,0,1,.28873,1.52c-.1593-1.2.08961.35.13939.59q.13938.63.29869,1.26a21.06275,21.06275,0,0,0,.87615,2.57c1.06532,2.59-1.16488,5.4-3.47474,6.15a3.19358,3.19358,0,0,1-.69694.14C5.914,55.14,8.204,70.62,7.82564,83c-.57747,18.57-.57747,49-.57747,49s.6372,576.13-.99563,587.33a5.14529,5.14529,0,0,1,3.05658,6,29.22893,29.22893,0,0,1-2.65832,7,4.69483,4.69483,0,0,1,.84628,2.91c-.26882,14.38,12.077,22.59,23.66608,28.18a5.66959,5.66959,0,0,1,.87615.53h166.1703a5.05453,5.05453,0,0,1,2.82758-1.08,4.08858,4.08858,0,0,1,1.583-1.45c.99563-.5,2.061-.93,3.10635-1.37l.63722-.27-.54758.24a6.826,6.826,0,0,0,1.28437-.6c.219-.11.448-.18.677-.27.99562-1,1.85185-1.92,2.39946-2.37,2.89728-2.43,6.20278-4.26,7.82562-7.81a4.37454,4.37454,0,0,1,1.73239-2c.80645-4.9,2.12069-9.72,2.5687-14.7a5.33774,5.33774,0,0,1,.56752-2,1.92248,1.92248,0,0,0-.1095-.51c-.37835-1.74-.8662-3.44-1.27441-5.17A4.80654,4.80654,0,0,1,224.09593,719Z"
          />
          <path
            :class="className"
            d="M224.29507,654.52v-554c.76662-12.76,2.62847-38.62,5.49586-48.14L230,51.69l-.59738-.38a21.29124,21.29124,0,0,1-3.66391-3.14,63.02656,63.02656,0,0,1,2.32977-9.56l.11947-.34-2.47907-28.1-1.07527-.34c-2.509-.8-9.66754-4-9.66754-8.12V0H15.024V1.71c0,4.13-6.9694,7.26-9.66755,8.12l-1.07528.34L1.812,38.28l.11948.34a64.23307,64.23307,0,0,1,2.32977,9.54A20.93372,20.93372,0,0,1,.59738,51.32L0,51.7l.20908.69C3.07649,61.89,4.97814,87.7,5.695,100.48v554c-.71685,12.75-2.6185,48.62-5.48591,58.13L0,713.3l.59738.38a20.76441,20.76441,0,0,1,3.66391,3.14,61.86478,61.86478,0,0,1-2.32977,9.56l-.11948.35,2.46916,28.1,1.07528.34c2.68819.86,9.66755,4,9.66755,8.12V765H214.966v-1.71c0-4.13,6.9694-7.26,9.66754-8.12l1.07527-.34,2.46916-28.1-.11947-.35a64.23172,64.23172,0,0,1-2.32976-9.54,20.93312,20.93312,0,0,1,3.6639-3.16l.59738-.38-.20907-.69c-2.86741-9.5-4.71927-45.31-5.48592-58.09m-3.82321,73.29s.448,1.07.99563,2.61a29.91379,29.91379,0,0,1-1.32417,12.42c-2.91721,8.76-10.06582,15.16-20.76882,18.74H30.54587c-22.89945-7.63-22.70032-25.7-22.06312-31.09.58742-1.63,1.05537-2.75,1.08524-2.83a12.25228,12.25228,0,0,0-2.09082-9.76c3.36522-18.83,1.65274-42.81,1.57309-43.89V91.12c.08961-1.19,1.80209-25.21-1.56314-44.05a12.45343,12.45343,0,0,0,2.041-9.88s-.448-1.07-.99563-2.61A29.92378,29.92378,0,0,1,9.82685,22.16C12.764,13.4,19.91256,7,30.62552,3.42H199.44421c22.94921,7.63,22.7003,25.7,22.06311,31.09-.58741,1.63-1.05536,2.75-1.08523,2.84a12.23211,12.23211,0,0,0,2.09083,9.75c-3.36523,18.83-1.65275,42.81-1.57308,43.89V673.88c-.0896,1.19-1.80208,25.21,1.56314,44a12.45342,12.45342,0,0,0-2.041,9.88m7.87311-675.3c-1.71,6.15-3,17.57-4,28.45a191.48013,191.48013,0,0,1,1.5-30.51,23.5903,23.5903,0,0,0,2.5,2.06m-5.72-14.58c.09-.21,1.13-2.72,2.12-5.82l.51,5.74a61.15693,61.15693,0,0,0-1.75006,6.6,9.49991,9.49991,0,0,1-.89-6.47m.42-25.21,1.24,14.07a31.5754,31.5754,0,0,1-1,3.69,30.09944,30.09944,0,0,0-1.55-8.72c-2-6-6.88-13.57-18.42-18.34h8.89c1.25,5.24,8,8.26,10.8,9.3M18.17021,3.42h8.84118C10.44414,10.29,7.42738,23.17,7.17848,30.61c-.37834-1.25-.73677-2.56-.99563-3.82L7.41743,12.72c2.7778-1,9.50825-4.06,10.75278-9.3M5.22705,37.85l.50777-5.74c.99563,3.07,1.99125,5.53,2.061,5.66a9.76825,9.76825,0,0,1-.82637,6.56A62.4619,62.4619,0,0,0,5.247,37.85M4.64958,50.44A192.25139,192.25139,0,0,1,6.12311,81c-.99563-10.87-2.28-22.29-3.98251-28.44a21.82554,21.82554,0,0,0,2.47911-2.07m-2.47911,662c1.70252-6.15,2.98688-17.57,3.98251-28.44a192.24174,192.24174,0,0,1-1.49344,30.5,23.50089,23.50089,0,0,0-2.48907-2.06m5.695,14.58c-.0896.21-1.12506,2.72-2.11073,5.82l-.50777-5.74A60.75,60.75,0,0,0,6.9694,720.6a9.53688,9.53688,0,0,1,.8861,6.47m-.41816,25.21L6.18285,738.21a32.23,32.23,0,0,1,.99563-3.69,30.11827,30.11827,0,0,0,1.54322,8.72c1.99126,6,6.84992,13.57,18.33947,18.34h-8.891c-1.24453-5.24-7.965-8.26-10.75278-9.3m204.82758,9.3h-8.88c16.64-6.86,19.67-19.75,19.92-27.19.38,1.26.74,2.56,1,3.82l-1.24,14.07c-2.79,1-9.55,4.06-10.8,9.3m13-34.43-.51,5.74c-1-3.08-2-5.53-2.07-5.66a9.7301,9.7301,0,0,1,.85-6.56,62.23563,62.23563,0,0,0,1.73,6.48m.6-12.59a191.36971,191.36971,0,0,1-1.51-30.51c1,10.88,2.29,22.29,4,28.44a21.90029,21.90029,0,0,0-2.49,2.07"
          />
        </svg>
      </div>

      <h2 class="sr-only">Skills</h2>

      <div class="relative">
        <div id="cs-subsections__skills-header" class="flex mb-[5px]">
          <div class="w-[30px]">
            <div class="sr-only">Proficiency</div>
            <abbr title="Proficiency" class="column-header">Prof</abbr>
          </div>
          <div class="w-[40px] px-[5px]">
            <div class="sr-only">Modifier</div>
            <abbr title="Modifier" class="column-header">Mod</abbr>
          </div>
          <div class="flex-1">
            <span class="column-header">Skill</span>
          </div>
          <div>
            <span class="column-header">Bonus</span>
          </div>
        </div>

        <div id="cs-subsections__skills-list" class="max-h-[700px] overflow-y-auto">
          <SkillListItem
            v-for="skill in skills"
            :key="`cs-subsection__skill-list-item-${skill.name}`"
            :className="className"
            :skill="skill"
            :proficiency="proficientSkills.get(skill.name) || ''"
            :advantages="skillsAdvantages.get(skill.name) || {}"
            :modifier="getSkillModifier(skill)"
            :character="character"
          />
        </div>
      </div>

      <div class="subsection-footer">Skills</div>
    </div>
  </div>
</template>

<style scoped>
.column-header {
  @apply text-[10px] font-bold uppercase text-cs-gray cursor-default tracking-tightest;
}
</style>
