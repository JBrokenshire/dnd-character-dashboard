<script setup lang="ts">
import { onMounted, ref } from 'vue'
import { modifierFromLevel } from '@/utils/utils'
import type { CharacterSense } from '@/models/CharacterSense'
import { characterProficiencyBonus } from '@/models/Character'
import { getCharacterSenses } from '@/services/CharacterSenseService'
import { getCharacterProficientSkills } from '@/services/CharacterSkillService'
import type { CharacterProficientSkills } from '@/models/CharacterProficientSkills'
import SenseCallout from '@/components/character/sheet/subsections/SenseCallout.vue'

const props = defineProps<{
  className: string
  character: character
}>()

const proficientSkills = ref<CharacterProficientSkills[]>([])
const senses = ref<CharacterSense[]>([])

const perceptionModifier = ref<number>(0)
const investigationModifier = ref<number>(0)
const insightModifier = ref<number>(0)

const loading = ref<boolean>(true)

const getSenseModifiers = (proficientSkills: CharacterProficientSkills[]) => {
  perceptionModifier.value = 10 + modifierFromLevel(props.character.wisdom)
  investigationModifier.value = 10 + modifierFromLevel(props.character.intelligence)
  insightModifier.value = 10 + modifierFromLevel(props.character.wisdom)

  for (const proficientSkill of proficientSkills.values()) {
    switch (proficientSkill.skill_name) {
      case 'Perception':
        perceptionModifier.value += characterProficiencyBonus(props.character.level)
        break
      case 'Investigation':
        investigationModifier.value += characterProficiencyBonus(props.character.level)
        break
      case 'Insight':
        insightModifier.value += characterProficiencyBonus(props.character.level)
        break
    }
  }
}

onMounted(async () => {
  proficientSkills.value = await getCharacterProficientSkills(props.character.id)
  getSenseModifiers(proficientSkills.value)
  senses.value = await getCharacterSenses(props.character.id)
  loading.value = false
})
</script>

<template>
  <div
    v-if="!loading"
    id="ct-subsections__senses"
    class="absolute top-[214px] left-0 cursor-pointer"
  >
    <section class="relative h-[200px] w-[230px] xl:w-[281px] py-[13px] px-[20px]">
      <div class="svg-background">
        <!-- Large Screen SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 281 200" class="hidden xl:block">
          <path
            fill="#10161ADB"
            d="M274.78,153.59a27.53,27.53,0,0,0-.93-3c-1.71-4.27-1.13-39.26-1.13-39.26s0-12.67-.58-30.9c-.35-11.2,1.57-25,3.1-33.94a8.34,8.34,0,0,1-3-8.09,11.87,11.87,0,0,1,.79-2.54c0-1.16.12-2.31.26-3.46-.82-5.25-1.12-10.74-3.65-15.42S262.79,9.2,259,5.79c-.08-.08-.13-.15-.2-.23-2.22-1.06-4.61-1.79-6.78-3a6.15,6.15,0,0,1-.84-.57h-221c-.78.52-1.59,1-2.35,1.57A4.18,4.18,0,0,1,25,4.24c-6.23,5.4-13.07,9-15.73,17.58a46.94,46.94,0,0,0-1.78,9.43,3.2,3.2,0,0,1,.1.42c.27,1.51.42,3,.57,4.54,0,0,.13.91.13,1a14.6,14.6,0,0,0,.55,1.93,4.61,4.61,0,0,1-1.47,4.95,5.55,5.55,0,0,1-2.49,3c1.51,9,3.34,22.38,3,33.33-.58,18.23-.58,30.9-.58,30.9s.58,35-1.13,39.26a27.88,27.88,0,0,0-1.09,3.65,4.78,4.78,0,0,1,3,3.17c1.31,4,.41,8.33-.78,12.49A4.68,4.68,0,0,1,7.5,171C8.64,183.88,17.62,192.75,29,197.68A4.75,4.75,0,0,1,30.83,199h215.8c1.94-.54,3.91-1,5.81-1.65a3.83,3.83,0,0,1,1.31-.86,4.61,4.61,0,0,1,2.42-1.31l.75-.19a3.88,3.88,0,0,1,1.06-.81c1.25-.62,2.55-1.18,3.79-1.85a17.12,17.12,0,0,1,1.71-1.4,3.17,3.17,0,0,1,.65-.36c.08-.09.16-.17.23-.26s.57-.83.57-.83a5.39,5.39,0,0,1,2.46-2.06c.45-.55.88-1.12,1.29-1.69l.1-.12a37.3,37.3,0,0,0,4.72-17.11,3,3,0,0,1,0-.31c-1.65-3.32-1.28-6.59-1.53-10.19A4.68,4.68,0,0,1,274.78,153.59Z"
          />
          <path
            :class="className"
            d="M275.28,101.4v2c.77-12.53,2.64-42.67,5.52-52l.21-.68-.6-.37a20.9,20.9,0,0,1-3.68-3.08,60.93,60.93,0,0,1,2.34-9.38l.12-.34L276.7,10l-1.08-.34c-2.52-.78-9.71-3.91-9.71-8V0H15.09V1.68c0,4.05-7,7.12-9.71,8L4.3,10,1.82,37.56l.12.34a61.53,61.53,0,0,1,2.34,9.36A21.05,21.05,0,0,1,.6,50.36l-.6.38.21.67c2.88,9.33,4.74,39.41,5.51,52v-2C5,113.87,3.09,139.25.21,148.59l-.21.68.6.37a20.9,20.9,0,0,1,3.68,3.08,59.8,59.8,0,0,1-2.34,9.38l-.12.34L4.3,190l1.08.34c2.7.84,9.71,3.91,9.71,8V200H265.91v-1.68c0-4,7-7.12,9.71-8l1.08-.34,2.48-27.58-.12-.34a61.53,61.53,0,0,1-2.34-9.36,21.05,21.05,0,0,1,3.68-3.1l.6-.38-.21-.67c-2.88-9.33-4.74-34.65-5.51-47.19m-3.84,62.1s.45,1.05,1,2.57a28.69,28.69,0,0,1-1.33,12.18c-2.95,8.6-10.16,14.89-20.88,18.39H30.68c-23-7.48-22.8-25.21-22.16-30.51.59-1.59,1.06-2.7,1.09-2.78a11.79,11.79,0,0,0-2.1-9.57c3.38-18.48,1.66-42,1.58-43.08V89.42c.09-1.17,1.81-24.74-1.57-43.23A12,12,0,0,0,9.56,36.5s-.45-1.06-1-2.57A28.69,28.69,0,0,1,9.87,21.75c3-8.6,10.16-14.9,20.89-18.39H250.32c23.05,7.48,22.8,25.21,22.16,30.51-.59,1.59-1.06,2.7-1.09,2.78a11.79,11.79,0,0,0,2.1,9.57c-3.38,18.48-1.66,42-1.58,43.08v21.28c-.09,1.17-1.81,24.74,1.57,43.23a12,12,0,0,0-2.05,9.69m7.41-112c-1.71,6-3,17.24-4,27.91a184.33,184.33,0,0,1,1.5-29.93,24.77,24.77,0,0,0,2.5,2m-5.72-14.31c.09-.2,1.13-2.66,2.12-5.71l.51,5.64A58.68,58.68,0,0,0,274,43.57a9.17,9.17,0,0,1-.89-6.35m.42-24.74,1.24,13.81c-.25,1.19-.59,2.43-1,3.62a29,29,0,0,0-1.55-8.55c-2-5.88-6.88-13.33-18.42-18h8.89c1.25,5.13,8,8.1,10.8,9.12M18.25,3.36h8.88C10.49,10.1,7.46,22.74,7.21,30c-.38-1.23-.74-2.52-1-3.75L7.45,12.48c2.79-1,9.55-4,10.8-9.12m-13,33.79.51-5.64c1,3,2,5.43,2.07,5.56A9.4,9.4,0,0,1,7,43.51a59.87,59.87,0,0,0-1.73-6.36M4.64,49.5A184.34,184.34,0,0,1,6.15,79.44c-1-10.67-2.29-21.88-4-27.91a22.88,22.88,0,0,0,2.49-2m-2.49,99c1.71-6,3-17.24,4-27.91a184.33,184.33,0,0,1-1.5,29.93,23.42,23.42,0,0,0-2.5-2m5.72,14.31c-.09.2-1.13,2.66-2.12,5.71l-.51-5.63A59.49,59.49,0,0,0,7,156.43a9.17,9.17,0,0,1,.89,6.35m-.42,24.74L6.21,173.71c.25-1.18.59-2.42,1-3.62a29,29,0,0,0,1.55,8.55c2,5.89,6.88,13.33,18.42,18H18.25c-1.25-5.13-8-8.1-10.8-9.12m255.3,9.12h-8.88c16.64-6.73,19.67-19.38,19.92-26.68.38,1.23.74,2.52,1,3.75l-1.24,13.81c-2.79,1-9.55,4-10.8,9.12m13-33.78-.51,5.63c-1-3-2-5.43-2.07-5.56a9.41,9.41,0,0,1,.85-6.44,60.72,60.72,0,0,0,1.73,6.37m.6-12.36a184.34,184.34,0,0,1-1.51-29.94c1,10.67,2.29,21.88,4,27.91a22.88,22.88,0,0,0-2.49,2"
          />
        </svg>
        <!-- Small Screen SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 230 200" class="block xl:hidden">
          <path
            fill="#10161ADB"
            d="M223.79241,153.59a27.608,27.608,0,0,0-.92665-3c-1.70385-4.27-1.12594-39.26-1.12594-39.26s0-12.67-.57791-30.9c-.34874-11.2,1.56437-25,3.08887-33.94a8.35593,8.35593,0,0,1-2.98922-8.09,11.90127,11.90127,0,0,1,.78717-2.54,28.715,28.715,0,0,1,.25908-3.46c-.81706-5.25-1.116-10.74-3.63688-15.42s-6.82542-7.78-10.6018-11.19c-.0797-.08-.12954-.15-.1993-.23-2.212-1.06-4.59343-1.79-6.75563-3a6.12742,6.12742,0,0,1-.837-.57H30.07152c-.77719.52-1.58428,1-2.34155,1.57a4.15331,4.15331,0,0,1-2.81982.68c-6.20761,5.4-13.023,9-15.67347,17.58a47.09122,47.09122,0,0,0-1.7736,9.43,3.20851,3.20851,0,0,1,.09964.42c.269,1.51.41849,3,.568,4.54,0,0,.12954.91.12954,1a14.64046,14.64046,0,0,0,.548,1.93,4.62021,4.62021,0,0,1-1.46472,4.95,5.5453,5.5453,0,0,1-2.48105,3c1.50457,9,3.328,22.38,2.98922,33.33-.57792,18.23-.57792,30.9-.57792,30.9s.57792,35-1.12593,39.26a27.95546,27.95546,0,0,0-1.08609,3.65A4.77275,4.77275,0,0,1,8.051,157.4c1.30529,4,.40853,8.33-.7772,12.49A4.69483,4.69483,0,0,1,7.473,171c1.13591,12.88,10.08363,21.75,21.42273,26.68A4.7335,4.7335,0,0,1,30.71919,199h165.0244c1.933-.54,3.89595-1,5.78912-1.65a3.81486,3.81486,0,0,1,1.30529-.86,4.58851,4.58851,0,0,1,2.41131-1.31l.74731-.19a3.86723,3.86723,0,0,1,1.05618-.81c1.24551-.62,2.54083-1.18,3.77639-1.85a17.07178,17.07178,0,0,1,1.70385-1.4,3.15462,3.15462,0,0,1,.64765-.36c.0797-.09.15943-.17.22919-.26s.568-.83.568-.83a5.37543,5.37543,0,0,1,2.45115-2.06c.44839-.55.87684-1.12,1.28537-1.69l.09965-.12a37.40281,37.40281,0,0,0,4.703-17.11,3.01265,3.01265,0,0,1,0-.31c-1.64406-3.32-1.2754-6.59-1.5245-10.19A4.68107,4.68107,0,0,1,223.79241,153.59Z"
          />
          <path
            :class="className"
            d="M224.29061,101.4v2c.76723-12.53,2.63053-42.67,5.50015-52L230,50.72l-.59785-.37a20.84247,20.84247,0,0,1-3.66677-3.08,61.10991,61.10991,0,0,1,2.33159-9.38l.11956-.34L225.70552,10l-1.0761-.34c-2.51093-.78-9.67509-3.91-9.67509-8V0H15.03577V1.68c0,4.05-6.97485,7.12-9.67511,8L4.28455,10,1.81346,37.56l.11957.34a61.71326,61.71326,0,0,1,2.33159,9.36,20.993,20.993,0,0,1-3.66678,3.1L0,50.74l.20925.67c2.86964,9.33,4.723,39.41,5.49019,52v-2C4.982,113.87,3.07889,139.25.20925,148.59L0,149.27l.59784.37a20.84352,20.84352,0,0,1,3.66678,3.08A59.97805,59.97805,0,0,1,1.933,162.1l-.11957.34L4.28455,190l1.07611.34c2.6903.84,9.67511,3.91,9.67511,8V200H214.9543v-1.68c0-4,6.97484-7.12,9.67509-8l1.0761-.34,2.4711-27.58-.11956-.34a61.71415,61.71415,0,0,1-2.33159-9.36,20.99378,20.99378,0,0,1,3.66677-3.1l.59785-.38-.20924-.67c-2.86965-9.33-4.72295-34.65-5.49021-47.19m-3.82619,62.1s.44839,1.05.9964,2.57a28.78706,28.78706,0,0,1-1.3252,12.18c-2.93941,8.6-10.12349,14.89-20.805,18.39H30.56973c-22.91733-7.48-22.718-25.21-22.08035-30.51.58788-1.59,1.05619-2.7,1.08608-2.78A11.8232,11.8232,0,0,0,7.483,153.74c3.36785-18.48,1.654-42,1.57432-43.08V89.42C9.147,88.25,10.86083,64.68,7.493,46.19A12.03425,12.03425,0,0,0,9.52564,36.5s-.44838-1.06-.99641-2.57a28.78762,28.78762,0,0,1,1.3053-12.18C12.82374,13.15,19.958,6.85,30.64944,3.36H199.42033c22.96714,7.48,22.718,25.21,22.08036,30.51-.58788,1.59-1.05619,2.7-1.08608,2.78a11.82318,11.82318,0,0,0,2.09246,9.57c-3.36786,18.48-1.654,42-1.57431,43.08v21.28c-.08967,1.17-1.80349,24.74,1.56437,43.23a12.03425,12.03425,0,0,0-2.04262,9.69m7.38337-112c-1.70385,6-2.98922,17.24-3.98563,27.91a184.99022,184.99022,0,0,1,1.49461-29.93,24.6963,24.6963,0,0,0,2.491,2m-5.69945-14.31c.08968-.2,1.12595-2.66,2.11238-5.71l.50818,5.64a58.84459,58.84459,0,0,0-1.74377,6.47,9.19916,9.19916,0,0,1-.88682-6.35m.4185-24.74,1.23554,13.81a30.597,30.597,0,0,1-.99641,3.62,29.09268,29.09268,0,0,0-1.54442-8.55c-1.99281-5.88-6.85527-13.33-18.35379-18h8.858c1.2455,5.13,7.97124,8.1,10.76117,9.12M17.745,3.36h8.88C9.985,10.1,6.955,22.74,6.705,30c-.38-1.23-.74-2.52-1-3.75l1.24-13.77c2.79-1,9.55-4,10.8-9.12m-13,33.79.51-5.64c1,3,2,5.43,2.07,5.56a9.4,9.4,0,0,1-.83,6.44,59.8691,59.8691,0,0,0-1.73-6.36M4.135,49.5a184.3395,184.3395,0,0,1,1.51,29.94c-1-10.67-2.29-21.88-4-27.91a22.88006,22.88006,0,0,0,2.49-2m-2.49,99c1.71-6,3-17.24,4-27.91a184.33119,184.33119,0,0,1-1.5,29.93,23.41786,23.41786,0,0,0-2.5-2m5.72,14.31c-.09.2-1.13,2.66-2.12,5.71l-.51-5.63a59.48905,59.48905,0,0,0,1.76-6.51,9.17,9.17,0,0,1,.89,6.35m-.42,24.74-1.26-13.81a31.59812,31.59812,0,0,1,1-3.62,29,29,0,0,0,1.55,8.55c2,5.89,6.88,13.33,18.42,18h-8.93c-1.25-5.13-8-8.1-10.8-9.12m204.86064,9.12h-8.84809c16.58021-6.73,19.59932-19.38,19.84842-26.68.37864,1.23.73733,2.52.9964,3.75l-1.23553,13.81c-2.78,1-9.51566,4-10.76117,9.12M224.759,162.86l-.50818,5.63c-.99641-3-1.99281-5.43-2.06257-5.56a9.44012,9.44012,0,0,1,.84695-6.44,60.89563,60.89563,0,0,0,1.7238,6.37m.59785-12.36a184.99938,184.99938,0,0,1-1.50459-29.94c.99641,10.67,2.28178,21.88,3.98563,27.91a22.811,22.811,0,0,0-2.481,2"
          />
        </svg>
      </div>
      <h2 class="sr-only">Senses</h2>
      <div class="relative cursor-pointer text-white">
        <div id="ct-subsections__senses-callouts">
          <SenseCallout :className="className" skillName="Perception" :level="perceptionModifier" />
          <SenseCallout
            :className="className"
            skillName="Investigation"
            :level="investigationModifier"
          />
          <SenseCallout :className="className" skillName="Insight" :level="insightModifier" />
        </div>

        <div
          id="ct-subsections__senses-summary"
          class="h-[3.6em] leading-[1.2] text-[12px] mt-[6px] overflow-hidden flex-center flex-wrap text-cs-gray gap-x-2"
        >
          <p v-if="senses.length === 0">Additional Sense Types</p>
          <p v-else v-for="sense in senses" :key="sense.id">
            {{ sense.sense_name }} {{ sense.distance }} ft.
          </p>
        </div>
      </div>
    </section>
    <div id="cs-subsections__senses-footer" class="subsection-footer">Senses</div>
  </div>
</template>
